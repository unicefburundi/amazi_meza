{% extends "base.html" %}
{% load staticfiles %}
{% load i18n %}

{% block head %}
	<script language="JavaScript">

		$(document).ready(function() {
			$('.datepicker').datepicker({
			    dateFormat: 'yy-mm-dd',
			    startDate: '-3d'
			});

			$(".datepicker").datepicker("setDate", new Date());
			
			if ((".divmessage").length) {
				$(".divmessage").fadeIn('slow').animate({opacity: 1.0}, 1500).effect("pulsate", { times: 2 }, 800).fadeOut('slow'); 
			}
			
			if ((".diverror").length) {
				$(".diverror").fadeIn('slow').animate({opacity: 1.0}, 1500).effect("pulsate", { times: 2 }, 800); 
			}

			if ("{{ communes }}") {
				{% for c in communes %}
					$('#pbcommune').append('<option value="{{ c.code }}">{{ c.name }}</option>');
				{% endfor %}
			}

			fetchwanteddata()

		});

		<!-- ajax call to database -->
		function fetchCollines(code) {
			alert("-- fetchCollines --");
			$("#pbcolline option").each(function(){
        		if ($(this).val()) {
        			$(this).remove();
        		}
		    });

			$('#divpb').empty();
			if (code) {
				//initializesonic();

				ajaxurl = 'getcollinesincommune';
	            data = JSON.stringify({ 'code': code });

	            ajaxpostbackfunction = "fetchcollines";
	            ajaxpost(ajaxurl, data);
	        }
		}

		function fetchwanteddata() {
					console.log("======Debut  fetchwanteddata====")
					if (new Date($('#pbtartdate').val()) > new Date($('#pbendtdate').val())) {
		                messimsg = "Start date cannot be a date after the End date";
		                messititle = "Invalid Date Selection";
		                titleanimation = "messierror";
		                messiprompt(messimsg, messititle, titleanimation);
		                $('#overlay').remove();
		                return;
					}
			    	initializesonic();
			    	
			    	ajaxurl = 'getwanteddata';
		    		var level = null;
		    		var code = null;
		    		var start_date = null;
		    		var end_date = null;

		    		if ($('#pbcolline').val() != "") {
		    			level = "colline";
		    			code = $('#pbcolline').val();
		    		}else{
		    			if($('#pbcommune').val() != ""){
		    				level = "commune";
		    				code = $('#pbcommune').val();
		    			}else{
		    				level = "national";
		    				code = -1;
		    			}
		    		}


		    		if ($('#pbtartdate').val() != "") {
		    			start_date = $('#pbtartdate').val();
		    		}

		    		if ($('#pbendtdate').val() != "") {
		    			end_date = $('#pbendtdate').val();
		    		}

					$('#divpb').empty();

		    		if (level && code && start_date && end_date) {
				        data = JSON.stringify({ 'level': level, 'code': code, 'start_date': start_date, 'end_date': end_date });

			            ajaxpostbackfunction = "fetchwanteddata";
			            ajaxpost(ajaxurl, data);

			        } else {
			        	$('#overlay').remove();
			        }
			    }


		function ajaxpost(posturl, data) {
		        ajaxresults = null;
		        $.ajax({
		        	beforeSend: function(xhr, settings) {
				        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
				            xhr.setRequestHeader("X-CSRFToken", csrftoken);
				        }
				    },
		            type: 'POST',
		            url: posturl,
		            data: data,
		            contentType: 'application/json; charset=utf-8',
		            dataType: 'json',

		            success: function (response) {
		                if (ajaxpostbackfunction == "fetchcollines") {
		                	for (i = 0; i < response.length; i++) {
		                		var code = jQuery.makeArray(response[i].fields)[0].code;
		                		var name = jQuery.makeArray(response[i].fields)[0].name;
		                		
		                		$('#pbcolline').append('<option value=' + code +'>' + name + '</option>');
    						}
    						// fetch wanted data
		                	fetchwanteddata();
		                } else if (ajaxpostbackfunction == "fetchwanteddata") {
		                	if (response.length > 0) {
		                		alert(response);
		                	}else {
		                		$('#divpb').append('<p style="color:red;">No records found</p>');
		                	}
		                }

		                $('#overlay').remove();
		            },

		            failure: function (json) {
		                messimsg = "Error";
		                messititle = "Error";
		                titleanimation = "messierror";
		                messiprompt(messimsg, messititle, titleanimation);
		               $('#overlay').remove();
		            },

		            error: function (jqXHR, exception) {
		                messimsg = getajaxerrormessage(jqXHR, exception); //jqXHR.responseText;
		                messititle = "error";
		                titleanimation = "messierror";
		                messiprompt(messimsg, messititle, titleanimation);
		                $('#overlay').remove();
		            }
		        });
		        
		        return false;
		    }
		</script>
{% endblock %}


{% block container %}


	<div>
		{% if msg %}
			<div class="divmessage"><p>{{ msg }}</p></div>
		{% endif %}
		{% if err %}
			<div class="diverror"><p>{{ err }}</p></div>
		{% endif %}
	</div>
	
	<div>
		<div class="form-inline" style="padding-left :5px; padding-right :5px;">

			<label for="pbtartdate">{% trans "From:" %}</label>
			<div class="input-group date" data-provide="datepicker">
			    <input type="text" id="pbtartdate" class="form-control datepicker" readonly="readonly" style="width:130px" required="required" onchange="fetchwanteddata()">
			    <div class="input-group-addon">
			        <span class="glyphicon glyphicon-th"></span>
			    </div>
			</div>

			<label for="pbendtdate">{% trans "To:" %}</label>
			<div class="input-group date" data-provide="datepicker">
			    <input type="text" id="pbendtdate" class="form-control datepicker" readonly="readonly" style="width:130px" required="required" onchange="fetchwanteddata()">
			    <div class="input-group-addon">
			        <span class="glyphicon glyphicon-th"></span>
			    </div>
			</div>

			<div class="form-group">
				<label for="pbcommune">{% trans "Commune:" %}</label>
				<select id="pbcommune" class="form-control" style="width:140px" onchange="fetchCollines(this.value)" required="required">
					<option value="" selected="selected">[ {% trans "Select Commune" %} ]</option>
				</select>
			</div>
			<div class="form-group">
				<label for="pbcolline">{% trans "Colline:" %}</label>
				<select id="pbcolline" class="form-control" style="width:140px" onchange="fetchwanteddata(this.value)" required="required">
					<option value="" selected="selected">[ {% trans "Select Colline" %} ]</option>'
				</select>
			</div>

		</div>

		<hr style="margin-top:10px; margin-bottom:10px">
		
		<div id="divpb" class="form-inline" style="padding-left :5px; padding-right :5px;">

		{{response_data}}

		</div>

	</div>


{% endblock %}